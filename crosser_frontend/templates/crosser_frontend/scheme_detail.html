{% extends "crosser_frontend/base_site.html"%}
{% load staticfiles %}

{% block title %}
Crosser | Edit Scheme 
{% endblock %}

{% block extra_head %}
 <script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.4/underscore-min.js"></script>
 <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.0.7/angular.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.0.7/angular-resource.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/angular-ui-bootstrap/0.4.0/ui-bootstrap-tpls.min.js"></script>

<script src='{% static "crosser_frontend/filters.js" %}'></script>
<script src='{% static "crosser_frontend/schemeRes.js" %}'></script>
<script src='{% static "crosser_frontend/scheme.js" %}'></script>

{% endblock %}

{% block content %}
<div ng:app="scheme">
<div ng:hide="true">{% csrf_token %}</div>
<div ng:hide="true"><input type='hidden' name='userid' value='{{ user.id }}'/></div>
<div ng:controller="PlanCtrl">
<form name="scheme_form" novalidate>
<h1>Edit Scheme: </h1>
<input name="name" type="text" ng:model="scheme.name" placeholder="Scheme Name" required/> 
<label>Species:</label>
<select name="species" ng:model="scheme.species" ng:options="spec.resource_uri as spec.name for spec in species.objects" required>
</select>

<label>Simulation Granularity:</label>
<select ng:model="quality.state" ng:options="qual.id as qual.name for qual in quality.opts" ng:click="set_quality(quality.state)">
</select>
<div id="advanced" ng:show="quality.state == -1">
<label>Chunk Size:</label>
<input name="conv_chunk_size" type="text" ng:model="scheme.system.convergence_chunk_size" required/>
<label>Tolerance:</label>
<input name="conv_tolerance" type="text" ng:model="scheme.system.convergence_tolerance" required/>
<label>Fewest Plants:</label>
<input name="fewest_plants" type="text" ng:model="scheme.system.convergence_fewest_plants" required/>
</div> 
<br/>
<hr>
<h1>Plants:</h1>
<div ng:repeat="plant in scheme.plants | orderBy : 'id'">
<b>Name:</b> <input name="pname{[{plant.id}]}" type="text" ng:change="change_plant(plant)" ng:model="plant.name" placeholder="Plant Name" required/>
        <a class="btn btn-danger" ng:click="remove_plant(plant)" >
            <i class="icon-trash icon-white"></i>
        </a>
<h4>Loci</h4> 

<table ng:hide="plant.loci.length == 0" class="table table-condensed">
<thead>
<tr>
    <th>Name:</th>
    <th>Type:</th>
    <th>LinkageGroup:</th>
    <th>Position:</th>
    <th></th>
</tr>
</thead>
<tr ng:repeat="l in plant.loci | orderBy : 'id'">
    <td><input name="lname{[{l.id}]}" type="text" ng:model="l.name" placeholder="Locus Name" required> </td>
    <td>
        <select ng:model="l.locus_type">
            <option value="Tr">Trait</option>
            <option value="Ma">Marker</option>
        </select>
    </td>
    <td> <input ng:model="l.linkage_group" type="number" placeholder="1-{[{get_max_link_group()}]}" min="1" max="{[{get_max_link_group()}]}" required>
    </td>
    <td>
        <input ng:model="l.position" type="number" placeholder="1-{[{get_max_position(l.linkage_group)}]}" min="1" max="{[{get_max_position(l.linkage_group)}]}" required>
        </select>

    </td>
    <td>
        <a class="btn btn-danger" ng:click="remove_locus(l, plant)" >
            <i class="icon-trash icon-white"></i>
        </a>
    </td>
</tr>
</table>
<button class="btn" ng:click="add_locus(plant)"><i class="icon-plus"></i>Add Locus</button>
<hr>
</div>
<button class="btn" ng:click="add_plant(scheme)"><i class="icon-plus"></i>Add Plant</button>
<hr>
<h1>Crosses:</h1>
<table class="table table-condensed" ng:hide="scheme.crosses.length == 0">
<thead>
<tr>
    <th>Name:</th> 
    <th>L Parent:</th>
    <th>R Parent:</th>
    <th>Protocol Zygosity:</th>
    <th>Loci To Select For:</th>
    <th></th>
</tr>
</thead>

<tr ng:repeat="c in scheme.crosses | orderBy : 'id'">
    <td><input type="text" ng:change="change_cross(c)" ng:model="c.name" placeholder="Cross Name" class="small-drop" required></td>
    <td class="ng-binding">
        <select ng:model="cross_data[c.resource_uri].left_parent" 
                ng:change="change_left_parent(c)"
                ng:options="item.resource_uri as item.name
                            group by item.type
                            for item in poss_parents | parents: c.resource_uri : cross_data[c.resource_uri].descendants | orderBy: 'resource_uri'"
                class="small-drop" required>
        </select>
    </td>
    <td class="ng-binding"> 
        <select ng:model="cross_data[c.resource_uri].right_parent" 
                ng:change="change_right_parent(c)"
                ng:options="item.resource_uri as item.name 
                            group by item.type
                            for item in poss_parents | parents: c.resource_uri : cross_data[c.resource_uri].descendants | orderBy: 'resource_uri'"
                class="small-drop" required>
        </select>
    </td>
    <td>
        <select ng:model="c.protocol_zygosity" class="small-drop" required>
            <option value="He">Heterozygous</option>
            <option value="Ho">Homozygous</option>
        </select>

    <td>
        <span ng:repeat="l in c.loci" type="text">
        <span class="badge badge-important"> {[{get_locus_by_uri(l).name}]} <i class="icon-remove icon-white" ng:click="remove_cross_locus(c, l)"></i>
        </span>
        &nbsp;
        </span>
        <div class="dropdown">
        <a class="dropdown-toggle badge badge-info">Add<i class="icon-plus icon-white"></i></a>
        <ul class="dropdown-menu" role="menu" aria-labelledby="dLabel">
            <rep ng:repeat="p in cross_data[c.resource_uri].ancestors">
            <li ng:repeat="l in p.loci | without_loci: c.loci | orderBy: 'id'"><a ng:click="c.loci.push(l.resource_uri)">{[{l.name}]}</a></li>
            </rep>
            <rep><li><a ng:click="add_all_cross_loci(c)">Add All</a></li></rep>
        </ul>   
        </div> 
    </td>
    <td>
        <a class="btn btn-danger" ng:click="remove_cross(c)" >
            <i class="icon-trash icon-white"></i>
        </a>
    </td>
</tr>
</table>
<button class="btn" ng:click="add_cross(scheme)"><i class="icon-plus"></i>Add Cross</button>
<hr>
<h1>Outputs:</h1>
<div ng:repeat="o in scheme.outputs">
        <select ng:model="output_data[o.resource_uri].output_type"
                ng:change="change_output_type(o)"
            class="small-drop" required>
            <option value="mean_cross_composition">Mean Cross Composition</option>
            <option value="success_probability">Success Probability</option>
            <option value="loci_composition">Loci Composition</option>
            <option value="proportion_distribution">Proportion Distribution</option>
            <option value="Cm">Custom</option>
        </select>
        <br/>

        <span ng:hide="output_data[o.resource_uri].output_type != 'mean_cross_composition'">
            <select multiple ng:model="output_data[o.resource_uri].data"
                    ng:change="change_output_data(o)"
                    ng:options="item.name as item.name
                            for item in scheme.crosses | orderBy: 'id'" required> </select>
        </span>
        <span ng:hide="output_data[o.resource_uri].output_type != 'success_probability'">
            <select multiple ng:model="output_data[o.resource_uri].data"
                    ng:change="change_output_data(o)"
                    ng:options="item.name as item.name
                            for item in scheme.crosses | orderBy: 'id'" required> </select>
 
        </span>
        <span ng:hide="output_data[o.resource_uri].output_type != 'loci_composition'">
            Cross: 
            <select ng:model="output_data[o.resource_uri].cross"
                    ng:change="change_output_data(o)"
                    ng:options="item.name as item.name
                            for item in scheme.crosses | orderBy: 'id'" required> </select>
        </span>
        <span ng:hide="output_data[o.resource_uri].output_type != 'proportion_distribution'">
            Donor: 
            <select ng:model="output_data[o.resource_uri].donor"
                    ng:change="change_output_data(o)"
                    ng:options="item.name as item.name
                            for item in scheme.plants | orderBy: 'id'"  required> </select>
 
            Cross: 
            <select ng:model="output_data[o.resource_uri].cross"
                    ng:change="change_output_data(o)"
                    ng:options="item.name as item.name
                            for item in scheme.crosses | orderBy: 'id'" required> </select>
 

        </span>
        <span ng:hide="output_data[o.resource_uri].output_type != 'Cm'">
        Type:
        <input type="text" ng:model="o.output_type" required/>
        Data:     
        <input type="text" ng:model="o.data" placeholder="Output Data" required/> 
        </span>

        <a class="btn btn-danger" ng:click="remove_output(o)" >
            <i class="icon-trash icon-white"></i>
        </a>
<hr> 
</div>

<button class="btn" ng:click="add_output(scheme)"><i class="icon-plus"></i>Add Output</button>
<br/>
<br/>
<button class="btn btn-primary" ng:click="scheme_update(scheme)">Save Scheme</button>
<br/>
<br/>
<button class="btn btn-primary" ng:click="process_scheme('{%url "process" scheme.id%}')">Save &amp; Process Scheme</a>

</form>
</div>
</div>
{% endblock %}
{% block navid%}crosses{% endblock %}
{% block js_code%}{#empty block to wipe out code#} 
{% endblock %}

